#!/bin/bash

# This script generates src.mk, which is included in the Makefile.
#
# src.mk imposes the following module rules:
#
#	1. Every directory in `/src` and its descendant directories, including
#	`/src` itself, defines a module.
#
#	2. Every C file within a module can include headers from the
#	`[root]/include` directory (if it exists) where `[root]` is the module
#	root directory. E.g., `/src/main.c` and `/src/ast/expr.c` can both
#	include headers from `/src/include`, but `/src/ast/expr.c` can also
#	include from `/src/ast/include`.
#
#	3. Every C file is treated as its own translation unit.
#
#	4. Every `.c` and `.h` file in the directory is a Makefile-dependency of
#	every other such file.
#
# This script also generates Synastic config files for Vim that reflect these
# rules.

set +x

SRCDIR=src
BUILDDIR=build

printf "# Generated by $(pwd)/$(basename $0) at $(date "+%s")\n\n"

# listincludes: output a list of the appropriate include directories from the
# given path, in keeping with rule (2.) above
function listincludes() {
	path=$1
	includedir=$path/include
	ls $includedir 2>/dev/null && echo $includedir
	parent=$(dirname $path)
	if [[ $parent != "." ]]; then
		listincludes $parent
	fi
}

function listobjects() {
	srcdirs=$1
	for dir in $srcdirs; do
		printf $dir
	done
}

INCLUDEDIRS=$(find $SRCDIR -type d -name "include")
SRCDIRS=$(find $SRCDIR -type d ! -name "include")

# create build dirs
for dir in $SRCDIRS; do
	build_dir=$(echo $dir | sed "s/^$SRCDIR/$BUILDDIR/")
	mkdir -p $build_dir
done

# headers
printf "HEADERS ="
for dir in $INCLUDEDIRS; do
	for f in $(find $dir -maxdepth 1 -type f -name "*.h"); do
		printf " \\"			# escape previous line
		printf "\n\t$f"
	done
done
printf "\n\n"

# objects
printf "OBJECTS ="
for dir in $SRCDIRS; do
	build_dir=$(echo $dir | sed "s/^$SRCDIR/$BUILDDIR/")
	for f in $(find $dir -maxdepth 1 -type f -name "*.c"); do
		obj=$build_dir/$(basename $f | sed "s/.c$/.o/;")
		printf " \\"			# escape previous line
		printf "\n\t$obj"
	done
done
printf "\n\n"

# object build commands
for dir in $SRCDIRS; do
	build_dir=$(echo $dir | sed "s/^$SRCDIR/$BUILDDIR/")
	printf "\n# $dir with build dir /$build_dir\n"
	includes=$(listincludes $dir)
	for f in $(find $dir -maxdepth 1 -type f -name "*.c"); do
		obj=$build_dir/$(basename $f | sed "s/.c$/.o/;")
		printf "$obj: \$(HEADERS) parser\n"
		printf "\t@printf \"CC\\\\t\$@\\\\n\"\n"
		printf "\t@\$(CC) \$(CFLAGS) -o \$@ -c $f "
		for inc in $includes; do
			printf -- '\\\n\t\t-I %s ' $inc
		done
		printf "\n"
	done
done
