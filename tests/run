#!/bin/bash

set -eu

printf 'running test suite at %s\n\n' "$(date)"
start=$(date +"%s")

ntests=0
npass=0

expected_suffix="EXPECTED"
fail_prefix="FAIL"
topological_folder="topological"
main_func="main"

pass="\e[32mPASS\e[0m\n"
fail="\e[31mFAIL\e[0m\n"

libx=$(pwd)/libx
XR0=$(realpath "$XR0")
cd tests
length=$(ls */*.x | awk '{ print length, $0 }' | sort -n -s | cut -d' ' -f2- |
	tail -1 | wc -c)


for f in */*.x
do
	ntests=$((ntests+1))
	folder=$(dirname "$f")

	printf "%-${length}s ..." "$f"
	set +e
	if [ "$folder" == *"$topological_folder"* ]
	then
		if [[ "$f" == *"verification"* ]]
		then
			command="$XR0 -x main -I $libx -v $f 2>&1 >/dev/null"
			output=$($XR0 -x main -I $libx -v $f 2>&1 >/dev/null)
		else
			command="$XR0 -t main -I $libx $f 2>&1 >/dev/null"
			output=$($XR0 -t main -I $libx $f 2>&1 >/dev/null)
		fi
	else 
		command="$XR0 -I $libx $f 2>&1 >/dev/null"
		output=$($XR0 -I $libx $f 2>&1 >/dev/null)
	fi
	set -e

	# cases where we have an expected output to compare with
	if [[ "$f" == *"${fail_prefix}"* || "$folder" == *"$topological_folder"* ]]
	then
		expected_file="${f}.${expected_suffix}"
		
		if echo "$output" | diff - $expected_file
		then
			npass=$((npass+1))
			printf "$pass"
		else
			printf "$fail"
			echo "=== ACTUAL"
			echo "$output"
			echo
			echo "=== EXPECTED"
			cat "$expected_file"
			echo
			echo "run this test: $command"
		fi
	else
		# silence is golden
		if [[ "$output" == "" ]]
		then
			npass=$((npass+1))
			printf "$pass"
		else
			printf "$fail"
			echo "=== ACTUAL"
			echo "$output"
			echo
			echo "expected no output"
			echo "run this test: $command"
		fi
	fi
done

nfail=$((ntests-npass))
finish=$(date +"%s")
printf '\n%d tests:\t%d passed\t%d failed\tin %d seconds\n' \
	$ntests $npass $nfail $((finish-start))
if [ $nfail -ne 0 ]
then
	exit 1
fi
